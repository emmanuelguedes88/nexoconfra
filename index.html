<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nexo Quiz de Natal üéÑ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- FIREBASE (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- CONFETTI -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Nunito', sans-serif; 
            background-color: #7f1d1d;
            overflow: hidden; 
            position: fixed;
            width: 100%;
            height: 100%;
        }

        /* NEVE */
        #snow-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0;
        }
        .snowflake {
            position: absolute; color: white; font-size: 1.5rem; animation: snowfall linear infinite;
        }
        @keyframes snowfall {
            0% { transform: translateY(-10vh) translateX(0px); opacity: 0.8; }
            100% { transform: translateY(100vh) translateX(20px); opacity: 0.2; }
        }

        /* SCROLL AREA */
        #app-scroll-area {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto;
            z-index: 10;
            padding: 1rem;
            padding-top: 90px; 
            padding-bottom: 160px; /* Espa√ßo generoso para o rodap√© */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* BOT√ïES TOPO */
        .quantum-top-btn {
            position: fixed; top: 15px; z-index: 999999 !important; background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(4px); border-radius: 9999px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid rgba(255,255,255,0.5);
            transition: transform 0.1s;
        }
        .quantum-top-btn:active { transform: scale(0.95); background: #fff; }
        .btn-exit { left: 15px; padding: 8px 16px; color: #991b1b; font-weight: bold; gap: 6px; }
        .btn-music { right: 15px; width: 42px; height: 42px; color: #1f2937; }

        /* BOT√ÉO ADMIN NUCLEAR */
        .nuclear-admin-btn {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999999 !important;
            background: linear-gradient(to bottom, #16a34a, #15803d);
            color: white;
            border: 2px solid #a7f3d0;
            border-bottom: 6px solid #14532d;
            border-radius: 20px;
            padding: 16px 32px;
            width: 90%;
            max-width: 350px;
            font-weight: 900;
            font-size: 1.1rem;
            text-transform: uppercase;
            text-align: center;
            white-space: nowrap;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            animation: pulse 2s infinite;
        }
        .nuclear-admin-btn:active {
            transform: translateX(-50%) translateY(4px);
            border-bottom-width: 2px;
            animation: none;
        }
        .btn-restart {
            background: linear-gradient(to bottom, #dc2626, #b91c1c);
            border-color: #fca5a5;
            border-bottom-color: #7f1d1d;
        }

        @keyframes pulse {
            0% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.02); }
            100% { transform: translateX(-50%) scale(1); }
        }

        /* Interfaces */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            border: 4px solid rgba(255,255,255,0.3);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 500px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .btn-main {
            background: linear-gradient(to bottom, #16a34a, #15803d); color: white; border-bottom: 5px solid #14532d;
            border-radius: 12px; padding: 15px; width: 100%; font-weight: 900; font-size: 1.2rem; text-transform: uppercase;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.1s;
        }
        .btn-main:active { transform: translateY(3px); border-bottom-width: 2px; }
        
        .player-chip {
            background: white; padding: 10px; border-radius: 12px; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); animation: popIn 0.3s forwards; border-left: 4px solid #16a34a;
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        
        .waiting-pulse {
            animation: textPulse 1.5s infinite;
        }
        @keyframes textPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ICONS
        const IconPlay = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>;
        const IconExit = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>;
        const IconMusic = ({on}) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">{on ? <path d="M11 5L6 9H2v6h4l5 4V5zM19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/> : <path d="M11 5L6 9H2v6h4l5 4V5zM23 9l-6 6M17 9l6 6"/>}</svg>;
        const IconUsers = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
        const IconCrown = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 4l3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></svg>;
        const IconRotate = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>;

        const firebaseConfig = {
            apiKey: "AIzaSyDg5YQ0e8IQkNieAaJQdlzt2ykrkw95W5c",
            authDomain: "nexusconfra.firebaseapp.com",
            projectId: "nexusconfra",
            storageBucket: "nexusconfra.firebasestorage.app",
            messagingSenderId: "328429270442",
            appId: "1:328429270442:web:e4d79c3eb93fa6b30f27d3",
            measurementId: "G-PB08JG5XYJ"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = 'nexo_quiz_final_v43_senior_fix';

        const QUESTIONS = [
            { question: "Em qual cidade Jesus nasceu? üèôÔ∏è", options: ["Nazar√©", "Bel√©m", "Jerusal√©m", "Galileia"], answer: 1 },
            { question: "Qual anjo visitou Maria? üëº", options: ["Miguel", "Rafael", "Gabriel", "Uriel"], answer: 2 },
            { question: "O que guiou os Reis Magos? ‚≠ê", options: ["GPS", "Vis√£o", "Voz", "Estrela"], answer: 3 },
            { question: "Quais foram os presentes? üéÅ", options: ["Ouro, Prata, Bronze", "Ouro, Incenso, Mirra", "Roupas e Comida", "Incenso e Prata"], answer: 1 },
            { question: "Onde Jesus dormiu? üõå", options: ["Ber√ßo de Ouro", "Cama Real", "Manjedoura", "No Ch√£o"], answer: 2 },
            { question: "Quem visitou primeiro? üêë", options: ["Pastores", "Reis Magos", "Soldados", "Vizinhos"], answer: 0 },
            { question: "Imperador Romano da √©poca? üëë", options: ["J√∫lio C√©sar", "Nero", "C√©sar Augusto", "Tib√©rio"], answer: 2 },
            { question: "Por que foram a Bel√©m? üìú", options: ["Fugir", "Passear", "Recenseamento", "Festa"], answer: 2 },
            { question: "Qual rei perseguiu Jesus? ‚öîÔ∏è", options: ["Pilatos", "Herodes", "Fara√≥", "Saul"], answer: 1 },
            { question: "Profeta do nascimento? üìú", options: ["Mois√©s", "Elias", "Isa√≠as", "Jeremias"], answer: 2 }
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [nickname, setNickname] = useState('');
            const [isAdmin, setIsAdmin] = useState(false);
            const [localState, setLocalState] = useState('login'); 
            const [serverStatus, setServerStatus] = useState('waiting');
            const [players, setPlayers] = useState([]);
            const [currentQIndex, setCurrentQIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [timeLeft, setTimeLeft] = useState(20);
            const [answered, setAnswered] = useState(false);
            const [selectedOpt, setSelectedOpt] = useState(null);
            const [musicOn, setMusicOn] = useState(false);
            const audioRef = useRef(new Audio("https://actions.google.com/sounds/v1/holidays/deck_the_halls.ogg"));
            const timerRef = useRef(null);

            useEffect(() => {
                audioRef.current.loop = true; audioRef.current.volume = 0.3;
                auth.signInAnonymously().catch(console.error);
                auth.onAuthStateChanged(setUser);
                try {
                    db.collection('artifacts').doc(appId).collection('public').doc('gameState').onSnapshot(s => {
                        if (s.exists) setServerStatus(s.data().status); else s.ref.set({status: 'waiting'});
                    });
                    db.collection('artifacts').doc(appId).collection('users').onSnapshot(s => setPlayers(s.docs.map(d => ({id: d.id, ...d.data()}))));
                } catch(e) { console.error(e); }
            }, []);

            useEffect(() => {
                if (serverStatus === 'playing' && localState === 'lobby') {
                    setLocalState('playing'); setScore(0); setCurrentQIndex(0); setTimeLeft(20); setAnswered(false);
                } else if (serverStatus === 'waiting' && localState === 'finished') {
                    setLocalState('lobby'); setScore(0);
                }
            }, [serverStatus, localState]);

            useEffect(() => {
                if (localState === 'playing' && !answered) {
                    if (timeLeft > 0) timerRef.current = setTimeout(() => setTimeLeft(t => t - 1), 1000);
                    else handleAnswer(-1);
                }
                return () => clearTimeout(timerRef.current);
            }, [timeLeft, localState, answered]);

            const toggleMusic = () => { if(musicOn) audioRef.current.pause(); else audioRef.current.play().catch(()=>{}); setMusicOn(!musicOn); };
            const toggleAdmin = () => setIsAdmin(!isAdmin);
            const joinGame = async () => {
                if(!nickname.trim()) return alert("Digite seu nome!");
                if(!user) return;
                if(!musicOn) audioRef.current.play().then(()=>setMusicOn(true)).catch(()=>{});
                await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).set({
                    name: nickname, score: 0, avatar: ['üéÖ','‚õÑ','ü¶å'][Math.floor(Math.random()*3)]
                });
                setLocalState('lobby');
            };
            const leaveGame = () => { setLocalState('login'); setNickname(''); setIsAdmin(false); };
            const adminStart = () => { db.collection('artifacts').doc(appId).collection('public').doc('gameState').set({status: 'playing'}, {merge:true}).catch(e=>alert(e.message)); };
            const adminReset = () => {
                db.collection('artifacts').doc(appId).collection('public').doc('gameState').set({status: 'waiting'}, {merge:true}).catch(e=>alert(e.message));
                players.forEach(p => db.collection('artifacts').doc(appId).collection('users').doc(p.id).update({score: 0}));
            };
            const handleAnswer = (idx) => {
                if(answered) return; setAnswered(true); setSelectedOpt(idx);
                if(idx === QUESTIONS[currentQIndex].answer) { confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 } }); setScore(s => s + 10 + timeLeft); }
                setTimeout(() => { if(currentQIndex < QUESTIONS.length - 1) { setCurrentQIndex(i => i + 1); setTimeLeft(20); setAnswered(false); setSelectedOpt(null); } else finishGame(); }, 2000);
            };
            const finishGame = async () => {
                setLocalState('finished'); confetti({ particleCount: 150 });
                if(user) await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).update({score: score});
            };
            const Snow = () => {
                const [flakes] = useState(Array.from({length: 15}));
                return <div id="snow-layer">{flakes.map((_,i) => <div key={i} className="snowflake" style={{ left: Math.random()*100+'%', fontSize: (Math.random()*20+10)+'px', animationDuration: (Math.random()*5+5)+'s', animationDelay: (Math.random()*5)+'s' }}>‚ùÑ</div>)}</div>;
            };

            return (
                <div style={{width:'100%', height:'100%'}}>
                    <Snow />
                    {localState !== 'login' && (
                        <>
                            <button onClick={leaveGame} className="quantum-top-btn btn-exit"><IconExit /> SAIR</button>
                            <button onClick={toggleMusic} className="quantum-top-btn btn-music"><IconMusic on={musicOn} /></button>
                        </>
                    )}
                    {isAdmin && localState === 'lobby' && <button onClick={adminStart} className="nuclear-admin-btn"><IconPlay /> INICIAR JOGO</button>}
                    {isAdmin && localState === 'finished' && <button onClick={adminReset} className="nuclear-admin-btn btn-restart"><IconRotate /> REINICIAR TUDO</button>}

                    <div id="app-scroll-area">
                        {localState === 'login' && (
                            <div className="glass-card text-center" style={{marginTop: 'auto', marginBottom: 'auto'}}>
                                <div className="text-6xl mb-4 animate-bounce">üéÖ</div>
                                <h1 className="text-4xl font-black text-red-600 mb-2">NEXO QUIZ</h1>
                                <p className="text-green-700 font-bold mb-6 text-sm">üéÑ Edi√ß√£o de Natal üéÑ</p>
                                <input className="w-full bg-gray-50 border-2 border-green-200 rounded-xl p-4 text-center text-lg font-bold mb-4 outline-none focus:border-green-500" placeholder="Digite seu Nome" value={nickname} onChange={e => setNickname(e.target.value)} />
                                <button onClick={joinGame} className="btn-main"><IconPlay /> ENTRAR</button>
                                <div className="mt-6 pt-4 border-t border-gray-200"><button onClick={toggleAdmin} className={`text-sm font-bold flex items-center justify-center gap-2 mx-auto transition-all ${isAdmin ? 'text-yellow-600 scale-110' : 'text-gray-400'}`}>{isAdmin ? <><IconCrown/> MODO ORGANIZADOR</> : "Sou o Organizador"}</button></div>
                            </div>
                        )}

                        {localState === 'lobby' && (
                            <>
                                <div className="glass-card text-center mb-4">
                                    <h2 className="text-2xl font-bold text-red-600 flex items-center justify-center gap-2 mb-2"><IconUsers /> Sagu√£o</h2>
                                    <p className="text-sm text-gray-500 font-bold">{players.length} participante(s) online</p>
                                    {!isAdmin && <div className="mt-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200 waiting-pulse"><p className="text-yellow-800 font-bold text-sm">Aguardando o Organizador iniciar...</p></div>}
                                    {isAdmin && <div className="mt-4 p-3 bg-green-50 rounded-lg border border-green-200"><p className="text-green-800 font-bold text-sm">Voc√™ √© o Organizador! <br/>Clique abaixo para come√ßar.</p></div>}
                                </div>
                                <div className="w-full max-w-[500px] grid grid-cols-2 gap-3">{players.map(p => <div key={p.id} className="player-chip"><span className="text-2xl">{p.avatar}</span><p className="font-bold text-gray-800 text-sm truncate">{p.name}</p></div>)}</div>
                            </>
                        )}

                        {localState === 'playing' && (
                            <div className="glass-card">
                                <div className="flex justify-between items-end mb-4">
                                    <div><span className="bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold block w-fit mb-1">Quest√£o {currentQIndex+1}/{QUESTIONS.length}</span><span className="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-xs font-bold block w-fit">‚≠ê {score}</span></div>
                                    <div className={`text-3xl font-black w-16 h-16 rounded-full border-4 flex items-center justify-center bg-white ${timeLeft<=5?'text-red-500 border-red-500 animate-pulse':'text-green-600 border-green-500'}`}>{timeLeft}</div>
                                </div>
                                <h2 className="text-xl font-bold text-gray-800 mb-6 min-h-[60px] flex items-center">{QUESTIONS[currentQIndex].question}</h2>
                                <div className="flex flex-col gap-3">{QUESTIONS[currentQIndex].options.map((opt, i) => {
                                    let style = "bg-gray-100 text-gray-700 border-gray-200";
                                    if(answered) { if(i === QUESTIONS[currentQIndex].answer) style = "bg-green-500 text-white border-green-700"; else if(i === selectedOpt) style = "bg-red-500 text-white border-red-700 opacity-80"; else style = "bg-gray-200 opacity-50"; }
                                    return <button key={i} onClick={() => handleAnswer(i)} className={`p-4 rounded-xl font-bold text-left transition-all border-b-4 ${style} ${!answered && 'active:translate-y-1 active:border-b-2'}`} disabled={answered}>{opt}</button>
                                })}</div>
                            </div>
                        )}

                        {localState === 'finished' && (
                            <>
                                <div className="glass-card text-center mb-4">
                                    <div className="text-5xl mb-2 animate-bounce">üèÜ</div>
                                    <h2 className="text-2xl font-black text-gray-800">RANKING FINAL</h2>
                                </div>
                                
                                {/* CONTAINER DA LISTA DE RANKING BLINDADO */}
                                <div className="w-full max-w-[500px] bg-white rounded-2xl shadow-lg overflow-hidden mb-32 border-b-8 border-green-700 relative z-20" style={{minHeight: '300px'}}>
                                    <div className="max-h-[60vh] overflow-y-auto custom-scrollbar divide-y divide-gray-100">
                                        {[...players].sort((a,b) => b.score - a.score).map((p, i) => {
                                            
                                            // √çCONE DE POSI√á√ÉO
                                            let rankIcon;
                                            if (i === 0) rankIcon = <span className="text-4xl filter drop-shadow-sm">ü•á</span>;
                                            else if (i === 1) rankIcon = <span className="text-4xl filter drop-shadow-sm">ü•à</span>;
                                            else if (i === 2) rankIcon = <span className="text-4xl filter drop-shadow-sm">ü•â</span>;
                                            else rankIcon = <span className="text-lg font-bold text-gray-400">#{i + 1}</span>;

                                            return (
                                                <div key={p.id} className={`flex items-center p-4 gap-3 h-24 ${p.id === user?.uid ? 'bg-yellow-50' : 'bg-white'}`}>
                                                    
                                                    {/* COL 1: POSI√á√ÉO */}
                                                    <div className="flex-none w-16 flex justify-center items-center">
                                                        {rankIcon}
                                                    </div>
                                                    
                                                    {/* COL 2: NOME */}
                                                    <div className="flex-1 min-w-0 flex flex-col justify-center text-left">
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-2xl flex-shrink-0">{p.avatar}</span>
                                                            <span className="font-bold text-gray-800 text-lg truncate">
                                                                {p.name}
                                                            </span>
                                                        </div>
                                                        {p.id === user?.uid && <span className="text-[10px] font-black text-green-600 bg-green-100 px-2 py-0.5 rounded-full w-fit uppercase tracking-wider mt-1">VOC√ä</span>}
                                                    </div>

                                                    {/* COL 3: PONTOS */}
                                                    <div className="flex-none text-right min-w-[70px]">
                                                        <span className="block font-black text-xl text-green-700 leading-none">{p.score}</span>
                                                        <span className="text-[10px] text-gray-400 font-bold uppercase tracking-wider">PTS</span>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


